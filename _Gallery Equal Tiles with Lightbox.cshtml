@inherits Custom.Hybrid.Razor12
@using ToSic.Razor.Blade;

@{
  var helpers = CreateInstance("shared/Helpers.cs");

  var page = GetService<ToSic.Sxc.Web.IPageService>();

  // Hybrid get page Parameters (works on Dnn & Oqtane)
  var albumInUrl = CmsContext.Page.Parameters["Album"];
  var isDetailViewOfAlbum = Text.Has(albumInUrl);
  @* If album QueryString is specified, take album from QueryString, else take "current" album *@
  var album = isDetailViewOfAlbum ? AsList(Data).FirstOrDefault(a => a.Path == albumInUrl) : Content;
  @* Show album not found notification and stop processing *@
  if (album == null) {
    <h1>@Resources.AlbumNotFound</h1>
    <div>@Html.Raw(Resources.AlbumNotFoundText)</div>
    <a href="@Tags.SafeUrl(Link.To())" class="btn btn-outline-primary btn-sm">@Resources.BackToOverview</a>

    page.SetHttpStatus(404);
    return;
  }

  page.SetTitle(album.Title + " | "); // will prepend to the existing title
  // You could also use this to replace the token [album] in the title with the title
  // page.SetTitle(album.Title, "[album]");
}

@* Hide the side navigation if the view is used as detail view *@
@if (isDetailViewOfAlbum) {
  <style>.ly-col-leftpane { display: none; }</style>
}

<div @Edit.TagToolbar(album)>
  @* Display Album Title or information that title is hidden *@
  @Html.Partial("shared/_AlbumTitleAndDescription.cshtml", new { album = album })

  @* Display the images *@
  <div class="ga-wrapper row auto-clear">
    @foreach (var pic in helpers.GetImagesSorted(album)) {
      var imgCaption = (Content.Presentation.ShowImageTitle && Text.Has(pic.Metadata.Title)) 
        ? ("<h6>" + Tags.Strip(pic.Metadata.Title) + "</h6><p>" + Tags.Strip(pic.Metadata.Description) + "</p>")
          .Replace("\"", "&quot;")
        : "";
      <div class="ga-tiles col-6 col-sm-6 col-md-4 col-lg-3">
        <div class="ga-image" @Edit.TagToolbar(toolbar: new [] {
          "toolbar=empty",
          "metadata?entityId=" + pic.Metadata.EntityId + "&contentType=ImageMetadata&for=file:" + pic.FileId
        })>
          <figure>
            <a class="ga-fancybox" href='@Tags.SafeUrl(pic.Url + "?w=1200&h=900&mode=max")' 
              data-fancybox="album-@CmsContext.Module.Id" data-caption="@imgCaption"
              >
            <div class="ga-img">
              <div class="overlay"></div>
              <img class="img-fluid" src='@Tags.SafeUrl(pic.Url + "?w=560&scale=both&quality=80&h=404&mode=crop")' alt="@pic.Metadata.Title" />
            </div>
          </a>
          </figure>
        </div>
      </div>
    }
  </div>
</div>

@* Show back button if the view is used as detail view *@
@if(isDetailViewOfAlbum) {
  <a href="@Tags.SafeUrl(Link.To())" class="btn btn-outline-primary btn-sm">@Resources.BackToOverview</a>
}

@Html.Partial("shared/_Assets.cshtml", new { scripts = true })


<script>
</script>